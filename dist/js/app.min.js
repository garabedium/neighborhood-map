function initApp(){"undefined"!=typeof google?(initMap(),ko.applyBindings(new ViewModel)):errorHandler("gmaps")}function errorHandler(e){var o=document.getElementById("errors"),n=document.getElementById("error-map"),a=document.getElementById("error-foursquare");o.className="","gmaps"===e?n.className="error":"foursquare"===e&&(a.className="error")}function ViewModel(){var e=this;e.shops=ko.observableArray(Model.shops),e.searchQuery=ko.observable(""),e.setInfoWindow=function(){setInfoWindowContent(this.marker)},e.search=ko.pureComputed(function(){return ko.utils.arrayFilter(e.shops(),function(o){var n=o.title.toLowerCase().indexOf(e.searchQuery().toLowerCase())>=0;return o.marker.setVisible(n),n})})}function initMap(){mapOptions={mapTypeControl:!1},map=new google.maps.Map(document.getElementById("map"),mapOptions),infowindow=new google.maps.InfoWindow,bounds=new google.maps.LatLngBounds,geocoder=new google.maps.Geocoder;for(var e=0,o=Model.shops.length;e<o;e++){var n=Model.shops[e],a=n.title,t=n.foursquare_id,r=n.location;new ajaxCall(t,e);var i=new google.maps.Marker({map:map,title:a,animation:google.maps.Animation.DROP,position:r,icon:defaultIcon});n.marker=i,n.infowindow=infowindow,i.addListener("click",function(){setInfoWindowContent(this)}),bounds.extend(n.marker.position)}map.fitBounds(bounds)}function ajaxCall(e,o){if(""!==e){var n=new XMLHttpRequest,a="https://api.foursquare.com/v2/venues/",t="&client_id=UAFFBB0O2TLTR0OFPRTCUIVPIWOQN14LCJLAQQUUNGQQYFR3",r="&client_secret=XAZIFQIDGV5SIFNSLJVEPRHOPRO3WNCI0GUNXLZAIDPOSIS1",i="&v=20130815",s=""+e+"/?",l=""+a+s+t+r+i;n.open("GET",l),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var e=JSON.parse(n.responseText);e=e.response.venue,Model.shops[o].marker.foursquare_data=e}else errorHandler("foursquare")},n.send()}}function setInfoWindowContent(e){function o(){for(var e=0;e<Model.shops.length;e++)Model.shops[e].marker.setIcon(defaultIcon)}function n(){r.forEach(function(e,o){var n=e.label,r=e.data,i="";void 0!==r&&(i=0==o?"<h2>"+r+"</h2>":"<strong>"+n+"</strong>: "+r,contentItem=document.createElement("li"),contentItem.innerHTML=i,t.appendChild(contentItem),a.appendChild(t))})}o(),e.setIcon(activeIcon),google.maps.event.addListener(infowindow,"closeclick",function(){e.setIcon(defaultIcon)});var a=document.createElement("div"),t=document.createElement("ul");a.className="window-content";var r=[{data:e.title},{label:"Address",data:e.foursquare_data.location.address},{label:"Rating",data:e.foursquare_data.rating}];if(void 0!==e.foursquare_data.hours){var i={label:"Status",data:e.foursquare_data.hours.status};r.push(i)}n(),infowindow.setContent(a),infowindow.open(map,e)}var Model={shops:[{title:"Bike House",foursquare_id:"55ce7fa6498eba4dad0a3907",location:{lat:-23.5630337,lng:-46.6908191}},{title:"Avanti Bike",foursquare_id:"4e468a8762e148603b732c4a",location:{lat:-23.5999037,lng:-46.6667808}},{title:"Bike Tech Jardins",foursquare_id:"4bc619776c26b713e74cecf3",location:{lat:-23.5613691,lng:-46.6690169}},{title:"Pedal Urbano",foursquare_id:"4ccb248797d0224bdf6e57b8",location:{lat:-23.5477529,lng:-46.688361}},{title:"Indy Bike Paraiso",foursquare_id:"4c4b3fec959220a176194e0f",location:{lat:-23.577449,lng:-46.642862}},{title:"Las Magrelas",foursquare_id:"55973b17498ec0e201f6c7ec",location:{lat:-23.5619013,lng:-46.6806354}}]};Model.shops.sort(function(e,o){return e.title>o.title?1:-1});var map,mapOptions,infowindow,bounds,geocoder,defaultIcon,activeIcon;defaultIcon="https://www.google.com/mapfiles/marker.png",activeIcon="https://www.google.com/mapfiles/marker_green.png";